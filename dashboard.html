{% extends "base.html" %}

{% block title %}Money Flow Dashboard - Upload Data{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">
                    <i class="fas fa-upload me-2"></i>
                    Upload Money Flow Data
                </h2>
            </div>
            <div class="card-body">
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <h4>Upload CSV File</h4>
                    <p class="text-muted">Drag and drop your nifty_detailed_YYYYMMDD_5min.csv file here or click to browse</p>
                    <form id="uploadForm" enctype="multipart/form-data">
                        <input type="file" id="fileInput" name="file" accept=".csv" class="d-none">
                        <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-folder-open me-2"></i>Choose File
                        </button>
                    </form>
                </div>
                
                <div id="uploadStatus" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-info-circle me-2"></i>Getting Started</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center mb-3">
                            <i class="fas fa-file-csv fa-2x text-primary"></i>
                            <h5 class="mt-2">1. Prepare Your Data</h5>
                            <p class="text-muted">Upload CSV file with required columns: timestamp, weighted_money_flow, cumulative_weighted_money_flow</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center mb-3">
                            <i class="fas fa-chart-bar fa-2x text-success"></i>
                            <h5 class="mt-2">2. Get Instant Analysis</h5>
                            <p class="text-muted">Receive real-time trading signals with 85-95% accuracy and 15-30 minute lead times</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center mb-3">
                            <i class="fas fa-trophy fa-2x text-warning"></i>
                            <h5 class="mt-2">3. Trade with Confidence</h5>
                            <p class="text-muted">Make informed decisions with institutional-level money flow insights</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadStatus = document.getElementById('uploadStatus');

    // Drag and drop functionality
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            uploadFile();
        }
    });

    // File input change
    fileInput.addEventListener('change', function() {
        if (fileInput.files.length > 0) {
            uploadFile();
        }
    });

    function uploadFile() {
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        uploadStatus.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Uploading and analyzing file...
            </div>
        `;

        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                uploadStatus.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        ${data.message}
                    </div>
                `;
                setTimeout(() => {
                    window.location.href = data.redirect;
                }, 1000);
            } else {
                uploadStatus.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        ${data.message}
                    </div>
                `;
            }
        })
        .catch(error => {
            uploadStatus.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error uploading file: ${error.message}
                </div>
            `;
        });
    }
});
</script>
{% endblock %}