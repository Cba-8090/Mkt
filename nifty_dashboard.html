<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced NIFTY Dashboard - Multi-timeframe & Signal Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a2332 100%);
            color: #ffffff;
            overflow-x: hidden;
        }

        .dashboard-container {
            max-width: 1920px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff88;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto auto;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }

        .card-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #00d4ff;
        }

        /* Multi-timeframe Controls */
        .timeframe-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 5px;
        }

        .timeframe-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #cccccc;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8em;
            font-weight: 600;
        }

        .timeframe-btn:hover {
            background: rgba(0, 212, 255, 0.2);
            border-color: #00d4ff;
            color: #00d4ff;
        }

        .timeframe-btn.active {
            background: linear-gradient(45deg, #00d4ff, #00ff88);
            border-color: transparent;
            color: #000;
            font-weight: bold;
        }

        .weight-badge {
            background: linear-gradient(45deg, #00d4ff, #0099cc);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .metric-label {
            color: #cccccc;
            font-size: 0.9em;
        }

        .metric-value {
            font-weight: bold;
            font-size: 1.1em;
            font-family: 'Courier New', monospace;
        }

        .positive {
            color: #00ff88;
        }

        .negative {
            color: #ff4444;
        }

        .neutral {
            color: #ffaa00;
        }

        .chart-container {
            height: 200px;
            margin-top: 15px;
        }

        .enhanced-chart-container {
            height: 150px;
            margin-top: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
        }

        /* Enhanced Scrollable Areas */
        .breakdown-signals-container,
        .price-reversals-container {
            max-height: 120px;
            overflow-y: auto;
            padding-right: 5px;
            margin-top: 10px;
        }

        .breakdown-signals-container::-webkit-scrollbar,
        .price-reversals-container::-webkit-scrollbar {
            width: 6px;
        }

        .breakdown-signals-container::-webkit-scrollbar-thumb {
            background: rgba(255, 68, 68, 0.6);
            border-radius: 3px;
        }

        .price-reversals-container::-webkit-scrollbar-thumb {
            background: rgba(78, 205, 196, 0.6);
            border-radius: 3px;
        }

        .breakdown-item,
        .reversal-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 10px;
            margin: 6px 0;
            border-radius: 5px;
            font-size: 0.85em;
            transition: background-color 0.2s ease;
        }

        .breakdown-item {
            border-left: 4px solid #ff4444;
        }

        .reversal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reversal-bullish {
            border-left: 4px solid #00ff88;
        }

        .reversal-bearish {
            border-left: 4px solid #ff4444;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .section-count {
            font-size: 0.8em;
            color: #999;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* Combined Signals Enhancement */
        .signals-card {
            grid-column: 1 / -1;
            grid-row: 4;
        }

        .signals-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-top: 20px;
        }

        .signal-display {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            margin: 0;
        }

        .signal-bullish {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 255, 136, 0.1));
            border: 2px solid #00ff88;
        }

        .signal-bearish {
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.2), rgba(255, 68, 68, 0.1));
            border: 2px solid #ff4444;
        }

        .signal-neutral {
            background: linear-gradient(135deg, rgba(255, 170, 0, 0.2), rgba(255, 170, 0, 0.1));
            border: 2px solid #ffaa00;
        }

        .signal-direction {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        /* Enhanced Signal Table */
        .signal-table-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .signal-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .signal-table-title {
            font-size: 1.1em;
            color: #00d4ff;
            font-weight: 600;
        }

        .table-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .export-btn {
            background: linear-gradient(45deg, #00ff88, #00d4ff);
            color: #000;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        .signal-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.85em;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }

        .signal-table th {
            background: linear-gradient(45deg, rgba(0, 212, 255, 0.3), rgba(0, 255, 136, 0.3));
            color: #ffffff;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid rgba(0, 212, 255, 0.5);
            font-size: 0.8em;
        }

        .signal-table td {
            padding: 10px 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-family: 'Courier New', monospace;
        }

        .signal-table tbody tr:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .signal-table tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Table cell styling */
        .timestamp-cell {
            color: #00d4ff;
            font-weight: bold;
        }

        .money-flow-cell {
            color: #00ff88;
        }

        .negative-flow {
            color: #ff4444;
        }

        .gamma-score-cell {
            font-weight: bold;
        }

        .high-score {
            color: #ff6b6b;
        }

        .medium-score {
            color: #ffaa00;
        }

        .low-score {
            color: #00ff88;
        }

        .signal-strength-cell {
            font-weight: bold;
        }

        .probability-cell {
            font-weight: bold;
        }

        .high-probability {
            color: #00ff88;
        }

        .medium-probability {
            color: #ffaa00;
        }

        .low-probability {
            color: #ff4444;
        }

        .trend-cell {
            font-weight: bold;
            text-transform: uppercase;
        }

        .bullish-trend {
            color: #00ff88;
        }

        .bearish-trend {
            color: #ff4444;
        }

        .neutral-trend {
            color: #ffaa00;
        }

        .remarks-cell {
            max-width: 150px;
            word-wrap: break-word;
            font-size: 0.75em;
            line-height: 1.2;
        }

        .table-scroll-container {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .table-scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .table-scroll-container::-webkit-scrollbar-thumb {
            background: rgba(0, 212, 255, 0.6);
            border-radius: 4px;
        }

        .levels-display {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .level-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 5px 10px;
            margin: 3px 0;
            border-radius: 5px;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .support-level {
            border-left: 4px solid #00ff88;
        }

        .resistance-level {
            border-left: 4px solid #ff4444;
        }

        .refresh-btn {
            background: linear-gradient(45deg, #00d4ff, #00ff88);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s ease;
        }

        .refresh-btn:hover {
            transform: scale(1.05);
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #555;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: #00ff88;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(25px);
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .signals-content {
                grid-template-columns: 1fr;
            }

            .signal-table {
                font-size: 0.75em;
            }

            .signal-table th,
            .signal-table td {
                padding: 8px 4px;
            }
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>ENHANCED NIFTY TRADING DASHBOARD</h1>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-indicator" id="connectionStatus"></div>
                    <span id="connectionText">Live Data</span>
                </div>
                <div class="status-item">
                    <span>Last Update: </span>
                    <span id="lastUpdate">--:--:--</span>
                </div>
                <div class="status-item auto-refresh">
                    <span>Auto Refresh:</span>
                    <div class="toggle-switch active" id="autoRefreshToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="status-item">
                    <button class="refresh-btn" onclick="fetchData()">Refresh Now</button>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <!-- Enhanced Futures Money Flow Card with Multi-timeframe -->
            <div class="card futures-card">
                <div class="card-header">
                    <div class="card-title">Futures Money Flow</div>
                    <div class="weight-badge">70% Weight</div>
                </div>

                <!-- Multi-timeframe Controls -->
                <div class="timeframe-controls">
                    <button class="timeframe-btn" data-timeframe="1min" data-chart="futures">1min</button>
                    <button class="timeframe-btn active" data-timeframe="5min" data-chart="futures">5min</button>
                    <button class="timeframe-btn" data-timeframe="15min" data-chart="futures">15min</button>
                    <button class="timeframe-btn" data-timeframe="1hr" data-chart="futures">1hr</button>
                </div>

                <div class="metric-row">
                    <span class="metric-label">Weighted Money Flow</span>
                    <span class="metric-value" id="weightedMoneyFlow">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Positive Flow</span>
                    <span class="metric-value positive" id="positiveFlow">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Negative Flow</span>
                    <span class="metric-value negative" id="negativeFlow">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Cumulative Flow</span>
                    <span class="metric-value" id="cumulativeFlow">--</span>
                </div>
                <div class="chart-container">
                    <canvas id="futuresChart"></canvas>
                </div>
            </div>

            <!-- Enhanced Options Flow Card with Multi-timeframe -->
            <div class="card options-card">
                <div class="card-header">
                    <div class="card-title">Options Flow</div>
                    <div class="weight-badge">30% Weight</div>
                </div>

                <!-- Multi-timeframe Controls -->
                <div class="timeframe-controls">
                    <button class="timeframe-btn" data-timeframe="1min" data-chart="options">1min</button>
                    <button class="timeframe-btn active" data-timeframe="5min" data-chart="options">5min</button>
                    <button class="timeframe-btn" data-timeframe="15min" data-chart="options">15min</button>
                    <button class="timeframe-btn" data-timeframe="1hr" data-chart="options">1hr</button>
                </div>

                <div class="metric-row">
                    <span class="metric-label">Net Flow</span>
                    <span class="metric-value" id="netFlow">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Sentiment</span>
                    <span class="metric-value" id="sentiment">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Bullish Flow</span>
                    <span class="metric-value positive" id="bullishFlow">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Bearish Flow</span>
                    <span class="metric-value negative" id="bearishFlow">--</span>
                </div>
                <div class="chart-container">
                    <canvas id="optionsChart"></canvas>
                </div>
            </div>

            <!-- Enhanced Gamma Analysis Card -->
            <div class="card gamma-card">
                <div class="card-header">
                    <div class="card-title">Gamma Analysis</div>
                </div>

                <!-- Multi-timeframe Controls -->
                <div class="timeframe-controls">
                    <button class="timeframe-btn" data-timeframe="1min" data-chart="gamma">1min</button>
                    <button class="timeframe-btn active" data-timeframe="5min" data-chart="gamma">5min</button>
                    <button class="timeframe-btn" data-timeframe="15min" data-chart="gamma">15min</button>
                    <button class="timeframe-btn" data-timeframe="1hr" data-chart="gamma">1hr</button>
                </div>

                <div class="metric-row">
                    <span class="metric-label">Support Pressure</span>
                    <span class="metric-value positive" id="supportPressure">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Resistance Pressure</span>
                    <span class="metric-value negative" id="resistancePressure">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">S/R Ratio</span>
                    <span class="metric-value" id="srRatio">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Max Pressure Strike</span>
                    <span class="metric-value" id="maxPressureStrike">--</span>
                </div>

                <div class="enhanced-chart-container">
                    <canvas id="srRatioChart"></canvas>
                </div>

                <div class="levels-display">
                    <div class="levels-column">
                        <h4 style="color: #00ff88; margin-bottom: 10px;">Support Levels</h4>
                        <div id="supportLevels"></div>
                    </div>
                    <div class="levels-column">
                        <h4 style="color: #ff4444; margin-bottom: 10px;">Resistance Levels</h4>
                        <div id="resistanceLevels"></div>
                    </div>
                </div>

                <div class="breakdown-signals">
                    <div class="section-header">
                        <div class="section-title" style="color: #ff4444;">⚠️ Breakdown Signals</div>
                        <div class="section-count" id="breakdownCount">0</div>
                    </div>
                    <div class="breakdown-signals-container" id="breakdownSignalsContainer">
                        <!-- Signals will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Enhanced Spot Price Card -->
            <div class="card spot-card">
                <div class="card-header">
                    <div class="card-title">Spot Price Analysis</div>
                </div>

                <!-- Multi-timeframe Controls -->
                <div class="timeframe-controls">
                    <button class="timeframe-btn" data-timeframe="1min" data-chart="spot">1min</button>
                    <button class="timeframe-btn active" data-timeframe="5min" data-chart="spot">5min</button>
                    <button class="timeframe-btn" data-timeframe="15min" data-chart="spot">15min</button>
                    <button class="timeframe-btn" data-timeframe="1hr" data-chart="spot">1hr</button>
                </div>

                <div class="metric-row">
                    <span class="metric-label">Current Price</span>
                    <span class="metric-value" id="spotPrice">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Change</span>
                    <span class="metric-value" id="priceChange">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Change %</span>
                    <span class="metric-value" id="priceChangePercent">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Trend Direction</span>
                    <span class="metric-value" id="trendDirection">--</span>
                </div>

                <div class="enhanced-chart-container">
                    <canvas id="spotPriceChart"></canvas>
                </div>

                <div class="price-reversals">
                    <div class="section-header">
                        <div class="section-title" style="color: #4ecdc4;">🔄 Recent Price Reversals</div>
                        <div class="section-count" id="reversalsCount">0/30</div>
                    </div>
                    <div class="price-reversals-container" id="priceReversalsContainer">
                        <!-- Reversals will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Enhanced Combined Signals Card with Detailed Table -->
            <div class="card signals-card">
                <div class="card-header">
                    <div class="card-title">Enhanced Combined Signals Analysis</div>
                </div>

                <div class="signals-content">
                    <div>
                        <!-- Multi-timeframe Controls for Combined Chart -->
                        <div class="timeframe-controls">
                            <button class="timeframe-btn" data-timeframe="1min" data-chart="combined">1min</button>
                            <button class="timeframe-btn active" data-timeframe="5min" data-chart="combined">5min</button>
                            <button class="timeframe-btn" data-timeframe="15min" data-chart="combined">15min</button>
                            <button class="timeframe-btn" data-timeframe="1hr" data-chart="combined">1hr</button>
                        </div>

                        <div class="signal-display" id="signalDisplay">
                            <div class="signal-direction" id="signalDirection">NEUTRAL</div>
                            <div class="signal-strength">Strength: <span id="signalStrength">0.0</span>/10</div>
                            <div class="signal-confidence">Confidence: <span id="signalConfidence">0</span>%</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="combinedChart"></canvas>
                        </div>
                    </div>

                    <!-- Enhanced Signal Analysis Table -->
                    <div class="signal-table-container">
                        <div class="signal-table-header">
                            <div class="signal-table-title">📊 Detailed Signal Analysis</div>
                            <div class="table-controls">
                                <button class="export-btn" onclick="exportSignalData()">📥 Export CSV</button>
                                <button class="export-btn" onclick="clearSignalHistory()">🗑️ Clear</button>
                            </div>
                        </div>

                        <div class="table-scroll-container">
                            <table class="signal-table" id="signalTable">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Future Flow</th>
                                        <th>Option Flow</th>
                                        <th>Gamma Score</th>
                                        <th>Combined Signal</th>
                                        <th>Probability</th>
                                        <th>Trend</th>
                                        <th>Remarks</th>
                                    </tr>
                                </thead>
                                <tbody id="signalTableBody">
                                    <!-- Table rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced global variables
        let autoRefresh = true;
        let refreshInterval;
        let futuresChart, optionsChart, combinedChart, srRatioChart, spotPriceChart;
        let historicalData = [];
        let allBreakdownSignals = [];
        let allPriceReversals = [];
        let signalHistory = [];
        let currentTimeframes = {
            futures: '5min',
            options: '5min',
            gamma: '5min',
            spot: '5min',
            combined: '5min'
        };

        // Enhanced formatting function for full number display
        function formatNumberFull(value, showSign = false, isPrice = false) {
            if (value === undefined || value === null || isNaN(value)) return '--';

            const sign = showSign && value > 0 ? '+' : '';

            // For prices and strikes, show full number with commas
            if (isPrice || (Math.abs(value) >= 10000 && Math.abs(value) < 100000)) {
                return sign + value.toLocaleString('en-IN', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 2
                });
            }

            // For large money flow values, use compact format
            if (Math.abs(value) >= 1000000) {
                return sign + (value / 1000000).toFixed(1) + 'M';
            } else if (Math.abs(value) >= 1000) {
                return sign + (value / 1000).toFixed(1) + 'K';
            } else {
                return sign + value.toFixed(0);
            }
        }

        // Generate sample signal data for demonstration
        function generateSampleSignalData() {
            const now = new Date();
            const timestamp = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });

            // Sample futures flow (realistic values)
            const futureFlow = (Math.random() - 0.5) * 2000000; // -1M to +1M

            // Sample options flow (realistic values)
            const optionFlow = (Math.random() - 0.5) * 500000; // -250K to +250K

            // Gamma pressure score (0-100)
            const gammaScore = Math.random() * 100;

            // Combined signal calculation (weighted)
            const combinedSignal = (futureFlow * 0.7 + optionFlow * 0.3) / 1000000;

            // Probability calculation based on signal strength
            const probability = Math.min(Math.abs(combinedSignal) * 100 + Math.random() * 20, 95);

            // Trend sentiment
            let trend = 'NEUTRAL';
            if (combinedSignal > 0.3) trend = 'BULLISH';
            else if (combinedSignal < -0.3) trend = 'BEARISH';

            // Generate remarks based on data
            const remarks = generateRemarks(futureFlow, optionFlow, gammaScore, combinedSignal);

            return {
                timestamp,
                futureFlow,
                optionFlow,
                gammaScore,
                combinedSignal,
                probability,
                trend,
                remarks
            };
        }

        // Generate intelligent remarks based on signal data
        function generateRemarks(futureFlow, optionFlow, gammaScore, combinedSignal) {
            const remarks = [];

            // Future flow analysis
            if (Math.abs(futureFlow) > 1500000) {
                remarks.push(`Strong ${futureFlow > 0 ? 'buying' : 'selling'} in futures`);
            }

            // Options flow analysis
            if (Math.abs(optionFlow) > 200000) {
                remarks.push(`High options ${optionFlow > 0 ? 'bullish' : 'bearish'} activity`);
            }

            // Gamma analysis
            if (gammaScore > 80) {
                remarks.push('High gamma pressure');
            } else if (gammaScore < 20) {
                remarks.push('Low gamma support');
            }

            // Signal strength
            if (Math.abs(combinedSignal) > 0.7) {
                remarks.push('Strong directional signal');
            } else if (Math.abs(combinedSignal) < 0.2) {
                remarks.push('Sideways movement expected');
            }

            // Agreement between futures and options
            if ((futureFlow > 0 && optionFlow > 0) || (futureFlow < 0 && optionFlow < 0)) {
                remarks.push('Futures-Options alignment');
            } else if (Math.abs(futureFlow) > Math.abs(optionFlow) * 2) {
                remarks.push('Futures divergence from options');
            }

            return remarks.length > 0 ? remarks.join('; ') : 'Normal market conditions';
        }

        // Add signal data to table
        function addSignalToTable(signalData) {
            const tbody = document.getElementById('signalTableBody');
            if (!tbody) return;

            const row = document.createElement('tr');

            // Format values with appropriate styling
            const futureFlowClass = signalData.futureFlow > 0 ? 'money-flow-cell' : 'negative-flow';
            const optionFlowClass = signalData.optionFlow > 0 ? 'money-flow-cell' : 'negative-flow';

            // Gamma score classification
            let gammaClass = 'low-score';
            if (signalData.gammaScore > 70) gammaClass = 'high-score';
            else if (signalData.gammaScore > 40) gammaClass = 'medium-score';

            // Signal strength classification
            let signalClass = 'signal-strength-cell';
            if (Math.abs(signalData.combinedSignal) > 0.7) signalClass += ' high-score';
            else if (Math.abs(signalData.combinedSignal) > 0.3) signalClass += ' medium-score';

            // Probability classification
            let probClass = 'probability-cell';
            if (signalData.probability > 70) probClass += ' high-probability';
            else if (signalData.probability > 40) probClass += ' medium-probability';
            else probClass += ' low-probability';

            // Trend classification
            let trendClass = 'trend-cell';
            if (signalData.trend === 'BULLISH') trendClass += ' bullish-trend';
            else if (signalData.trend === 'BEARISH') trendClass += ' bearish-trend';
            else trendClass += ' neutral-trend';

            row.innerHTML = `
                <td class="timestamp-cell">${signalData.timestamp}</td>
                <td class="${futureFlowClass}">${formatNumberFull(signalData.futureFlow, true)}</td>
                <td class="${optionFlowClass}">${formatNumberFull(signalData.optionFlow, true)}</td>
                <td class="gamma-score-cell ${gammaClass}">${signalData.gammaScore.toFixed(1)}</td>
                <td class="${signalClass}">${signalData.combinedSignal.toFixed(3)}</td>
                <td class="${probClass}">${signalData.probability.toFixed(1)}%</td>
                <td class="${trendClass}">${signalData.trend}</td>
                <td class="remarks-cell">${signalData.remarks}</td>
            `;

            // Add row to top of table
            if (tbody.firstChild) {
                tbody.insertBefore(row, tbody.firstChild);
            } else {
                tbody.appendChild(row);
            }

            // Limit table to 50 rows
            while (tbody.children.length > 50) {
                tbody.removeChild(tbody.lastChild);
            }

            // Store in signal history
            signalHistory.unshift(signalData);
            if (signalHistory.length > 100) {
                signalHistory = signalHistory.slice(0, 100);
            }
        }

        // Export signal data to CSV
        function exportSignalData() {
            if (signalHistory.length === 0) {
                alert('No signal data to export');
                return;
            }

            const headers = ['Timestamp', 'Future Flow', 'Option Flow', 'Gamma Score', 'Combined Signal', 'Probability', 'Trend', 'Remarks'];
            const csvContent = [
                headers.join(','),
                ...signalHistory.map(row => [
                    row.timestamp,
                    row.futureFlow.toFixed(2),
                    row.optionFlow.toFixed(2),
                    row.gammaScore.toFixed(2),
                    row.combinedSignal.toFixed(3),
                    row.probability.toFixed(1),
                    row.trend,
                    `"${row.remarks.replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nifty_signals_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Clear signal history
        function clearSignalHistory() {
            if (confirm('Are you sure you want to clear all signal history?')) {
                signalHistory = [];
                const tbody = document.getElementById('signalTableBody');
                if (tbody) {
                    tbody.innerHTML = '';
                }
            }
        }

        // Update support and resistance levels with full numbers
        function updateSupportResistanceLevels(gammaData) {
            const supportContainer = document.getElementById('supportLevels');
            const resistanceContainer = document.getElementById('resistanceLevels');

            if (supportContainer) {
                const supportLevels = gammaData.support_levels || [];
                supportContainer.innerHTML = supportLevels.length > 0 ?
                    supportLevels.map(level =>
                        `<div class="level-item support-level">${formatNumberFull(level, false, true)}</div>`
                    ).join('') :
                    '<div style="color: #999;">No support levels</div>';
            }

            if (resistanceContainer) {
                const resistanceLevels = gammaData.resistance_levels || [];
                resistanceContainer.innerHTML = resistanceLevels.length > 0 ?
                    resistanceLevels.map(level =>
                        `<div class="level-item resistance-level">${formatNumberFull(level, false, true)}</div>`
                    ).join('') :
                    '<div style="color: #999;">No resistance levels</div>';
            }
        }

        // Enhanced breakdown signals with full price display
        function updateBreakdownSignalsWithHistory() {
            const container = document.getElementById('breakdownSignalsContainer');
            const countElement = document.getElementById('breakdownCount');

            // Generate sample breakdown signals with full prices
            const sampleSignals = [
                {
                    time: '15:45:23',
                    signal: `CRITICAL BREAKDOWN: Support at ${formatNumberFull(24815, false, true)} breached with high volume`,
                    type: 'CRITICAL'
                },
                {
                    time: '15:42:15',
                    signal: `Support erosion detected at ${formatNumberFull(24820, false, true)} level`,
                    type: 'WARNING'
                },
                {
                    time: '15:38:07',
                    signal: `BREAKDOWN CONFIRMATION: Price broke below ${formatNumberFull(24825, false, true)}`,
                    type: 'CONFIRMATION'
                }
            ];

            allBreakdownSignals = [...sampleSignals, ...allBreakdownSignals.slice(0, 12)];

            if (countElement) {
                countElement.textContent = `${allBreakdownSignals.length}/50`;
            }

            if (allBreakdownSignals.length === 0) {
                container.innerHTML = '<div style="color: #00ff88; text-align: center; padding: 20px;">No Breakdown Signals</div>';
                return;
            }

            container.innerHTML = allBreakdownSignals.slice(0, 15).map(signal => {
                let typeColor = '#ff4444';
                let typeIcon = '⚠️';

                switch(signal.type) {
                    case 'CRITICAL':
                        typeColor = '#ff0000';
                        typeIcon = '🚨';
                        break;
                    case 'CONFIRMATION':
                        typeColor = '#ff6600';
                        typeIcon = '✅';
                        break;
                    case 'WARNING':
                        typeColor = '#ffaa00';
                        typeIcon = '⚠️';
                        break;
                }

                return `<div class="breakdown-item" style="border-left-color: ${typeColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="breakdown-time" style="color: #00d4ff; font-weight: bold;">${signal.time}</span>
                        <span style="color: ${typeColor}; font-size: 1.1em;">${typeIcon}</span>
                    </div>
                    <div style="margin-top: 4px; font-size: 0.85em; line-height: 1.3;">${signal.signal}</div>
                </div>`;
            }).join('');

            container.scrollTop = 0;
        }

        // Enhanced price reversals with full price display
        function updatePriceReversalsWithHistory() {
            const container = document.getElementById('priceReversalsContainer');
            const countElement = document.getElementById('reversalsCount');

            // Generate sample reversals with full prices
            const sampleReversals = [
                {
                    time: '15:47:30',
                    direction: 'BEARISH',
                    price: 24812.50
                },
                {
                    time: '15:35:15',
                    direction: 'BULLISH',
                    price: 24828.75
                },
                {
                    time: '15:22:08',
                    direction: 'BEARISH',
                    price: 24835.25
                }
            ];

            allPriceReversals = [...sampleReversals, ...allPriceReversals.slice(0, 7)];

            if (countElement) {
                countElement.textContent = `${allPriceReversals.length}/30`;
            }

            if (allPriceReversals.length === 0) {
                container.innerHTML = '<div style="color: #4ecdc4; text-align: center; padding: 20px;">No Recent Reversals</div>';
                return;
            }

            container.innerHTML = allPriceReversals.slice(0, 10).map(reversal => {
                const directionIcon = reversal.direction === 'BULLISH' ? '📈' : '📉';
                const directionColor = reversal.direction === 'BULLISH' ? '#00ff88' : '#ff4444';

                return `<div class="reversal-item reversal-${reversal.direction.toLowerCase()}">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="color: ${directionColor}; font-size: 1.1em;">${directionIcon}</span>
                        <span style="color: #00d4ff; font-weight: bold;">${reversal.time}</span>
                        <span style="color: ${directionColor};">${reversal.direction}</span>
                    </div>
                    <span style="font-weight: bold; font-family: 'Courier New', monospace;">${formatNumberFull(reversal.price, false, true)}</span>
                </div>`;
            }).join('');

            container.scrollTop = 0;
        }

        // Multi-timeframe functionality
        function setupTimeframeControls() {
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const timeframe = this.dataset.timeframe;
                    const chartType = this.dataset.chart;

                    // Update active state
                    const container = this.parentElement;
                    container.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // Store current timeframe
                    currentTimeframes[chartType] = timeframe;

                    // Update chart with new timeframe
                    updateChartTimeframe(chartType, timeframe);

                    console.log(`📊 Switched ${chartType} chart to ${timeframe} timeframe`);
                });
            });
        }

        // Update chart based on timeframe
        function updateChartTimeframe(chartType, timeframe) {
            // Calculate data points based on timeframe
            let maxDataPoints, intervalMinutes;

            switch(timeframe) {
                case '1min':
                    maxDataPoints = 60; // 1 hour of 1-min data
                    intervalMinutes = 1;
                    break;
                case '5min':
                    maxDataPoints = 60; // 5 hours of 5-min data
                    intervalMinutes = 5;
                    break;
                case '15min':
                    maxDataPoints = 48; // 12 hours of 15-min data
                    intervalMinutes = 15;
                    break;
                case '1hr':
                    maxDataPoints = 24; // 24 hours of 1-hr data
                    intervalMinutes = 60;
                    break;
                default:
                    maxDataPoints = 60;
                    intervalMinutes = 5;
            }

            // Generate sample historical data for the timeframe
            const now = new Date();
            const labels = [];

            for (let i = maxDataPoints - 1; i >= 0; i--) {
                const timePoint = new Date(now.getTime() - (i * intervalMinutes * 60000));
                labels.push(timePoint.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                }));
            }

            // Update the corresponding chart
            const chart = getChartByType(chartType);
            if (chart) {
                chart.data.labels = labels;

                // Generate sample data for each dataset
                chart.data.datasets.forEach(dataset => {
                    dataset.data = labels.map(() => (Math.random() - 0.5) * 1000000);
                });

                chart.update('none');
            }
        }

        // Get chart instance by type
        function getChartByType(chartType) {
            switch(chartType) {
                case 'futures': return futuresChart;
                case 'options': return optionsChart;
                case 'gamma': return srRatioChart;
                case 'spot': return spotPriceChart;
                case 'combined': return combinedChart;
                default: return null;
            }
        }

        // Enhanced dashboard update with full number formatting
        function updateDashboard(data) {
            if (!data) {
                // Generate sample data for demonstration
                data = generateSampleData();
            }

            // Update futures data with full formatting
            if (data.futures_data) {
                updateElement('weightedMoneyFlow', formatNumberFull(data.futures_data.weighted_money_flow, true));
                updateElement('positiveFlow', formatNumberFull(data.futures_data.weighted_positive_money_flow));
                updateElement('negativeFlow', formatNumberFull(data.futures_data.weighted_negative_money_flow));
                updateElement('cumulativeFlow', formatNumberFull(data.futures_data.cumulative_weighted_money_flow));
            }

            // Update options data
            if (data.options_data) {
                updateElement('netFlow', formatNumberFull(data.options_data.net_flow, true));
                updateElement('sentiment', data.options_data.sentiment);
                updateElement('bullishFlow', formatNumberFull(data.options_data.bullish_flow));
                updateElement('bearishFlow', formatNumberFull(data.options_data.bearish_flow));
            }

            // Update gamma data with full numbers
            if (data.gamma_data) {
                updateElement('supportPressure', formatNumberFull(data.gamma_data.support_pressure));
                updateElement('resistancePressure', formatNumberFull(data.gamma_data.resistance_pressure));
                updateElement('srRatio', data.gamma_data.sr_ratio?.toFixed(2));
                updateElement('maxPressureStrike', formatNumberFull(data.gamma_data.max_pressure_strike, false, true));

                updateSupportResistanceLevels(data.gamma_data);
            }

            // Update spot data with full price display
            if (data.spot_data) {
                updateElement('spotPrice', formatNumberFull(data.spot_data.spot_price, false, true));
                updateElement('priceChange', formatNumberFull(data.spot_data.price_change, true, true));
                updateElement('priceChangePercent', `${data.spot_data.price_change_pct?.toFixed(2)}%`);
            }

            if (data.gamma_data) {
                updateElement('trendDirection', data.gamma_data.trend_direction);
            }

            // Update signals
            if (data.signals) {
                updateSignalDisplay(data.signals);

                // Add to signal table
                const signalData = generateSampleSignalData();
                addSignalToTable(signalData);
            }

            updateBreakdownSignalsWithHistory();
            updatePriceReversalsWithHistory();
            updateTimestamp();
        }

        // Generate sample data for demonstration
        function generateSampleData() {
            return {
                futures_data: {
                    weighted_money_flow: (Math.random() - 0.5) * 2000000,
                    weighted_positive_money_flow: Math.random() * 3000000,
                    weighted_negative_money_flow: Math.random() * 2500000,
                    cumulative_weighted_money_flow: Math.random() * 15000000
                },
                options_data: {
                    net_flow: (Math.random() - 0.5) * 500000,
                    sentiment: Math.random() > 0.5 ? 'Bullish' : Math.random() > 0.5 ? 'Bearish' : 'Neutral',
                    bullish_flow: Math.random() * 400000,
                    bearish_flow: Math.random() * 400000
                },
                gamma_data: {
                    support_pressure: Math.random() * 1000000,
                    resistance_pressure: Math.random() * 700000,
                    sr_ratio: Math.random() * 4,
                    max_pressure_strike: 24800 + (Math.random() - 0.5) * 100,
                    support_levels: [24750, 24775, 24800].map(level => level + Math.random() * 20),
                    resistance_levels: [24850, 24875, 24900].map(level => level + Math.random() * 20),
                    trend_direction: Math.random() > 0.5 ? 'BULLISH' : Math.random() > 0.5 ? 'BEARISH' : 'NEUTRAL'
                },
                spot_data: {
                    spot_price: 24815.50 + (Math.random() - 0.5) * 50,
                    price_change: (Math.random() - 0.5) * 100,
                    price_change_pct: (Math.random() - 0.5) * 3
                },
                signals: {
                    combined_signal: (Math.random() - 0.5) * 2,
                    signal_strength: Math.random() * 10,
                    direction: Math.random() > 0.5 ? 'Bullish' : Math.random() > 0.5 ? 'Bearish' : 'Neutral',
                    confidence: Math.random() * 100
                }
            };
        }

        // Helper function to update elements
        function updateElement(id, value) {
            const element = document.getElementById(id);
            if (element && value !== undefined && value !== null) {
                element.textContent = value;

                // Add color classes based on value
                if (typeof value === 'string' && (value.includes('-') || value.includes('▼'))) {
                    element.className = 'metric-value negative';
                } else if (typeof value === 'string' && (value.includes('+') || value.includes('▲'))) {
                    element.className = 'metric-value positive';
                } else {
                    element.className = 'metric-value';
                }
            }
        }

        // Update signal display
        function updateSignalDisplay(signals) {
            const signalDisplay = document.getElementById('signalDisplay');
            const signalDirection = document.getElementById('signalDirection');
            const signalStrength = document.getElementById('signalStrength');
            const signalConfidence = document.getElementById('signalConfidence');

            if (signalDirection) signalDirection.textContent = signals.direction || 'NEUTRAL';
            if (signalStrength) signalStrength.textContent = signals.signal_strength?.toFixed(1) || '0.0';
            if (signalConfidence) signalConfidence.textContent = Math.round(signals.confidence || 0);

            // Update signal display styling
            if (signalDisplay) {
                signalDisplay.className = 'signal-display';

                if (signals.direction === 'Bullish') {
                    signalDisplay.classList.add('signal-bullish');
                } else if (signals.direction === 'Bearish') {
                    signalDisplay.classList.add('signal-bearish');
                } else {
                    signalDisplay.classList.add('signal-neutral');
                }
            }
        }

        // Update timestamp
        function updateTimestamp() {
            const timestampElement = document.getElementById('lastUpdate');
            if (timestampElement) {
                timestampElement.textContent = new Date().toLocaleTimeString();
            }
        }

        // Fetch data function
        async function fetchData() {
            try {
                updateTimestamp();
                // Simulate data fetching - in real implementation, this would call your API
                const data = generateSampleData();
                updateDashboard(data);
                console.log('📊 Dashboard updated with enhanced formatting');
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Initialize charts (simplified for demo)
        function initializeCharts() {
            // Initialize all charts with basic configuration
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#cccccc' } },
                    x: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#cccccc' } }
                }
            };

            // Initialize futures chart
            futuresChart = new Chart(document.getElementById('futuresChart'), {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Futures Flow', data: [], borderColor: '#00d4ff', tension: 0.4 }] },
                options: chartOptions
            });

            // Initialize other charts similarly...
            optionsChart = new Chart(document.getElementById('optionsChart'), {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Options Flow', data: [], borderColor: '#00ff88', tension: 0.4 }] },
                options: chartOptions
            });

            combinedChart = new Chart(document.getElementById('combinedChart'), {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Combined Signal', data: [], borderColor: '#ffaa00', tension: 0.4 }] },
                options: chartOptions
            });

            srRatioChart = new Chart(document.getElementById('srRatioChart'), {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'S/R Ratio', data: [], borderColor: '#ff6b6b', tension: 0.4 }] },
                options: chartOptions
            });

            spotPriceChart = new Chart(document.getElementById('spotPriceChart'), {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Spot Price', data: [], borderColor: '#4ecdc4', tension: 0.4 }] },
                options: chartOptions
            });
        }

        // Auto refresh functionality
        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            const toggle = document.getElementById('autoRefreshToggle');
            toggle.classList.toggle('active', autoRefresh);

            if (autoRefresh) {
                startAutoRefresh();
            } else {
                clearInterval(refreshInterval);
            }
        }

        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(fetchData, 30000); // 30 seconds
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            setupTimeframeControls();

            // Setup auto refresh toggle
            document.getElementById('autoRefreshToggle').addEventListener('click', toggleAutoRefresh);

            // Initial data load
            fetchData();
            startAutoRefresh();

            console.log('🚀 Enhanced NIFTY Dashboard Initialized');
            console.log('✅ Multi-timeframe support: 1min, 5min, 15min, 1hr');
            console.log('✅ Full number display for prices and strikes');
            console.log('✅ Detailed signal analysis table with export capability');
        });

        // Global API for debugging
        window.dashboardAPI = {
            fetchData,
            toggleAutoRefresh,
            exportSignalData,
            clearSignalHistory,
            updateTimeframe: updateChartTimeframe,
            getCurrentTimeframes: () => currentTimeframes,
            getSignalHistory: () => signalHistory
        };
    </script>
</body>
</html>